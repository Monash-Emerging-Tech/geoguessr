<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="theme-color" content="#000000">
    <title>MNET Geoguessr - Monash Clayton Campus</title>
    
    <!-- MazeMaps CSS -->
    <link rel="stylesheet" href="https://api.mazemap.com/js/v1.0.0/mazemap.min.css">
    <script src="https://api.mazemap.com/js/v1.0.0/mazemap.min.js"></script>
    
    <!-- Custom styles -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #000;
            overflow: hidden;
        }

        #unity-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        #unity-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #mazemap-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none; /* Disabled until game starts */
            opacity: 0; /* Hidden until game starts */
            transition: opacity 0.3s ease;
        }

        .map-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.1);
            z-index: 3;
            pointer-events: none; /* Overlay doesn't block clicks */
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            z-index: 10;
        }

        .loading::after {
            content: '';
            display: block;
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            margin: 10px auto 0;
            border-radius: 2px;
            position: relative;
            overflow: hidden;
        }

        .loading::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: var(--progress, 0%);
            background: white;
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        /* Map controls removed - submit button is handled by Unity */

        .marker-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 5;
            max-width: 300px;
        }

        .score-display {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 16px;
            z-index: 5;
        }

        .z-level-control {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 5;
        }

        .z-level-control label {
            font-weight: bold;
            margin-right: 8px;
            color: #333;
        }

        .z-level-control select {
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            min-width: 150px;
        }
    </style>
</head>
<body>
    <div id="unity-container">
        <canvas id="unity-canvas" tabindex="-1"></canvas>
        
        <!-- Map overlay for when map is active -->
        <div id="map-overlay" class="map-overlay"></div>
        
        <!-- MazeMap container -->
        <div id="mazemap-container"></div>
        
        <!-- Loading indicator -->
        <div id="loading" class="loading">Loading MNET Geoguessr...</div>
        
        <!-- Map controls removed - submit button is handled by Unity -->
        
        <!-- Z-Level Control -->
        <div id="z-level-control" class="z-level-control" style="display: block;">
            <label for="z-level-select">Floor:</label>
            <select id="z-level-select">
                <option value="-4">P4 (Parking Level 4)</option>
                <option value="-3">P3 (Parking Level 3)</option>
                <option value="-2">P2 (Parking Level 2)</option>
                <option value="-1">P1 (Parking Level 1)</option>
                <option value="0">LG (Lower Ground)</option>
                <option value="1" selected>G (Ground)</option>
                <option value="2">1 (First Floor)</option>
                <option value="3">2 (Second Floor)</option>
                <option value="4">3 (Third Floor)</option>
                <option value="5">4 (Fourth Floor)</option>
                <option value="6">5 (Fifth Floor)</option>
                <option value="7">6 (Sixth Floor)</option>
                <option value="8">7 (Seventh Floor)</option>
                <option value="9">8 (Eighth Floor)</option>
                <option value="10">9 (Ninth Floor)</option>
                <option value="11">10 (Tenth Floor)</option>
                <option value="12">11 (Eleventh Floor)</option>
            </select>
        </div>
        
        <!-- Score display -->
        <div id="score-display" class="score-display" style="display: none;">
            <div>Score: <span id="current-score">0</span></div>
            <div>Round: <span id="current-round">1</span></div>
        </div>
        
        <!-- Marker info display -->
        <div id="marker-info" class="marker-info" style="display: none;">
            <div id="marker-details"></div>
        </div>
    </div>

    <!-- Unity WebGL loader script -->
    <script>
        var container = document.querySelector("#unity-container");
        var canvas = document.querySelector("#unity-canvas");
        var loadingBar = document.querySelector("#loading");

        // Shows a temporary message banner/ribbon for a few seconds, or
        // a permanent error message on top of the canvas if type=='error'.
        // If type=='warning', a yellow highlight color is used.
        // Modify or remove this function to customize the permanently visible UI.
        function unityShowBanner(msg, type) {
            function updateBannerVisibility() {
                warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
            }
            var div = document.createElement('div');
            div.innerHTML = msg;
            warningBanner.appendChild(div);
            if (type == 'error') div.style = 'background: red; padding: 10px;';
            else {
                if (type == 'warning') div.style = 'background: yellow; padding: 10px;';
                setTimeout(function() {
                    warningBanner.removeChild(div);
                    updateBannerVisibility();
                }, 5000);
            }
            updateBannerVisibility();
        }

        var buildUrl = "Build";
        
        // Use the actual Unity loader file from your build
        var loaderUrl = buildUrl + "/geoguessr_build.loader.js";
        
        console.log('Attempting to load Unity from:', loaderUrl);
        var config = {
            dataUrl: buildUrl + "/geoguessr_build.data",
            frameworkUrl: buildUrl + "/geoguessr_build.framework.js",
            codeUrl: buildUrl + "/geoguessr_build.wasm",
            streamingAssetsUrl: "StreamingAssets",
            companyName: "{{{ COMPANY_NAME }}}",
            productName: "{{{ PRODUCT_NAME }}}",
            productVersion: "{{{ PRODUCT_VERSION }}}",
            showBanner: unityShowBanner,
        };
        
        console.log('Unity config:', config);

        // By default Unity keeps WebGL canvas render target size matched with
        // the DOM size of the canvas element (scaled by window.devicePixelRatio)
        // Set this to false if you want to decouple this synchronization from
        // happening inside the engine, and you would instead like to size up
        // the canvas DOM size and WebGL render target sizes yourself.
        // config.matchWebGLToCanvasSize = false;

        // Input modules are handled automatically by Unity
        // Uncomment the following lines if you need specific input:
        // config.keyboardInput = true;
        // config.mouseInput = true;
        // config.touchInput = true;
        // config.joystickInput = true;

        var script = document.createElement("script");
        script.src = loaderUrl;
        script.onload = () => {
            createUnityInstance(canvas, config, (progress) => {
                // Update loading progress
                var loadingElement = document.querySelector("#loading");
                if (loadingElement) {
                    loadingElement.style.setProperty('--progress', (100 * progress) + '%');
                    loadingElement.setAttribute('data-progress', (100 * progress).toFixed(0) + '%');
                }
            }).then((unityInstance) => {
                loadingBar.style.display = "none";
                
                // Store Unity instance globally for our JavaScript functions
                window.unityInstance = unityInstance;
                console.log('Unity instance created and stored globally');
            }).catch((message) => {
                alert(message);
            });
        };
        script.onerror = () => {
            alert("Failed to load the Unity WebGL loader. Please check your internet connection and try again.");
        };
        document.body.appendChild(script);

        // Add a warning banner for development builds
        var warningBanner = document.createElement('div');
        warningBanner.id = 'unity-warning';
        warningBanner.style.cssText = 'position: fixed; left: 0; top: 0; right: 0; background: white; z-index: 999;';
        document.body.appendChild(warningBanner);
    </script>

    <!-- Custom JavaScript for MazeMaps integration -->
    <script>
        // Global variables for Unity communication
        var unityInstance = null;
        var mazemapInstance = null;
        var currentGuess = null;
        var actualLocation = null;
        var isMapActive = false;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('MNET Geoguessr WebGL Template initialized');
            initializeMapControls();
        });

        // Map control initialization
        function initializeMapControls() {
            const zLevelSelect = document.getElementById('z-level-select');

            // Z-level control
            zLevelSelect.addEventListener('change', function() {
                const newLevel = parseInt(this.value);
                if (mazemapInstance && mazemapInstance.setZLevel) {
                    mazemapInstance.setZLevel(newLevel);
                    console.log(`Z-level changed to: ${getZLevelName(newLevel)}`);
                }
            });
        }

        // Initialize MazeMap (called by Unity when game starts)
        function initializeMazeMap() {
            if (mazemapInstance) {
                console.log('MazeMap already initialized');
                return; // Already initialized
            }

            console.log('Initializing MazeMap...');
            
            // Check if Mazemap is already available (loaded in head)
            if (typeof Mazemap !== 'undefined') {
                console.log('Mazemap object available, creating instance...');
                createMazeMapInstance();
            } else {
                console.error('Mazemap object not available');
                alert('Failed to initialize map. Please refresh the page.');
            }
        }

        // Create MazeMap instance
        function createMazeMapInstance() {
            try {
                console.log('Creating MazeMap instance...');
                
                if (typeof Mazemap === 'undefined') {
                    console.error('Mazemap object is not defined');
                    alert('Failed to initialize map. Please refresh the page.');
                    return;
                }
                
                const mapContainer = document.getElementById('mazemap-container');
                if (!mapContainer) {
                    console.error('Map container not found');
                    return;
                }
                
                // Clear any existing map
                mapContainer.innerHTML = '';
                
                // Create map div
                const mapDiv = document.createElement('div');
                mapDiv.id = 'mazemap';
                mapDiv.style.width = '100%';
                mapDiv.style.height = '100%';
                mapContainer.appendChild(mapDiv);

                console.log('Initializing MazeMap with config...');
                // Initialize MazeMap
                mazemapInstance = new Mazemap.Map({
                    container: mapDiv,
                    campuses: 'default',
                    center: { lng: 145.1361, lat: -37.9106 }, // Monash University Clayton
                    zoom: 18,
                    zLevel: 0,
                    minZLevel: 0,
                    maxZLevel: 12
                });

                // Set up map event handlers
                mazemapInstance.on('load', function() {
                    console.log('MazeMap loaded successfully');
                    setupMapClickHandler();
                });

                mazemapInstance.on('click', function(event) {
                    handleMapClick(event);
                });

                console.log('MazeMap instance created');
            } catch (error) {
                console.error('Error creating MazeMap instance:', error);
                alert('Failed to initialize map. Please refresh the page.');
            }
        }

        // Set up map click handler
        function setupMapClickHandler() {
            if (!mazemapInstance) return;

            mazemapInstance.on('click', function(event) {
                if (!isMapActive) return;

                const coords = event.lngLat;
                currentGuess = {
                    latitude: coords.lat,
                    longitude: coords.lng
                };

                // Update UI
                updateMarkerInfo('Guess placed at: ' + coords.lat.toFixed(6) + ', ' + coords.lng.toFixed(6));
                document.getElementById('submit-guess-btn').disabled = false;

                // Add marker to map
                addMarkerToMap(coords.lat, coords.lng, 'Your Guess', 'guess');
            });
        }

        // Handle map click with enhanced z-level data
        function handleMapClick(event) {
            if (!isMapActive) return;

            const coords = event.lngLat;
            
            // Get z-level information
            const zLevel = mazemapInstance.getZLevel ? mazemapInstance.getZLevel() : 0;
            const zLevelName = getZLevelName(zLevel);
            
            currentGuess = {
                latitude: coords.lat,
                longitude: coords.lng,
                zLevel: zLevel,
                zLevelName: zLevelName
            };

            // Send enhanced coordinates to Unity
            if (unityInstance) {
                const jsonData = JSON.stringify({
                    latitude: coords.lat,
                    longitude: coords.lng,
                    zLevel: zLevel,
                    zLevelName: zLevelName,
                    timestamp: Date.now()
                });
                
                try {
                    unityInstance.SendMessage('MapInteractionManager', 'OnMapClick', jsonData);
                } catch (error) {
                    console.error('Error sending message to Unity:', error);
                }
            }

            // Update UI with z-level info
            updateMarkerInfo(`Guess placed at: ${coords.lat.toFixed(6)}, ${coords.lng.toFixed(6)} (${zLevelName})`);

            // Add enhanced marker to map
            addEnhancedMarkerToMap(coords.lat, coords.lng, 'Your Guess', 'guess', zLevel);
        }

        // Z-level name helper function
        function getZLevelName(zLevel) {
            if (zLevel === -4) return 'P4 (Parking Level 4)';
            if (zLevel === -3) return 'P3 (Parking Level 3)';
            if (zLevel === -2) return 'P2 (Parking Level 2)';
            if (zLevel === -1) return 'P1 (Parking Level 1)';
            if (zLevel === 0) return 'LG (Lower Ground)';
            if (zLevel === 1) return 'G (Ground)';
            if (zLevel === 2) return '1 (First Floor)';
            if (zLevel === 3) return '2 (Second Floor)';
            if (zLevel === 4) return '3 (Third Floor)';
            if (zLevel === 5) return '4 (Fourth Floor)';
            if (zLevel === 6) return '5 (Fifth Floor)';
            if (zLevel === 7) return '6 (Sixth Floor)';
            if (zLevel === 8) return '7 (Seventh Floor)';
            if (zLevel === 9) return '8 (Eighth Floor)';
            if (zLevel === 10) return '9 (Ninth Floor)';
            if (zLevel === 11) return '10 (Tenth Floor)';
            if (zLevel === 12) return '11 (Eleventh Floor)';
            if (zLevel < -4) return `B${Math.abs(zLevel)} (Basement ${Math.abs(zLevel)})`;
            return `${zLevel} (Level ${zLevel})`;
        }

        // Enhanced marker creation with custom options
        function addEnhancedMarkerToMap(lat, lng, label, type, zLevel) {
            if (!mazemapInstance) return;

            try {
                // Create marker options based on type
                const markerOptions = {
                    imgUrl: type === 'actual' ? 'images/fat.svg' : 'images/handthing.svg',
                    imgScale: 1.7,
                    color: type === 'actual' ? '#9D9DDC' : 'white',
                    size: 60,
                    innerCircle: false,
                    shape: 'marker',
                    zLevel: zLevel
                };

                // Create marker using MazeMap API
                const marker = new Mazemap.MazeMarker(markerOptions)
                    .setLngLat([lng, lat])
                    .addTo(mazemapInstance);

                // Store reference for cleanup
                if (type === 'player') {
                    if (mazemapInstance._playerMarker) {
                        mazemapInstance._playerMarker.remove();
                    }
                    mazemapInstance._playerMarker = marker;
                } else if (type === 'actual') {
                    if (mazemapInstance._actualMarker) {
                        mazemapInstance._actualMarker.remove();
                    }
                    mazemapInstance._actualMarker = marker;
                }

                console.log(`Enhanced ${type} marker added at: ${lat}, ${lng}, Level: ${getZLevelName(zLevel)}`);
            } catch (error) {
                console.error(`Error creating enhanced ${type} marker:`, error);
            }
        }

        // Legacy marker function for backward compatibility
        function addMarkerToMap(lat, lng, label, type) {
            if (!mazemapInstance) return;

            try {
                // Create marker element
                const markerEl = document.createElement('div');
                markerEl.className = 'custom-marker ' + type;
                markerEl.style.cssText = `
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    background: ${type === 'guess' ? '#ff6b6b' : '#4ecdc4'};
                    border: 3px solid white;
                    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                    cursor: pointer;
                    position: relative;
                `;

                // Create popup
                const popup = new Mazemap.Popup({ offset: 25 })
                    .setLngLat([lng, lat])
                    .setHTML('<div style="padding: 5px; font-size: 12px;">' + label + '</div>')
                    .addTo(mazemapInstance);

                // Create marker
                new Mazemap.Marker({ element: markerEl })
                    .setLngLat([lng, lat])
                    .setPopup(popup)
                    .addTo(mazemapInstance);

                console.log('Marker added:', label, 'at', lat, lng);
            } catch (error) {
                console.error('Error adding marker:', error);
            }
        }

        // Activate map for guessing (show map and make it interactive)
        function showMap() {
            console.log('Showing map...');
            
            // Make map container visible and interactive
            const mapContainer = document.getElementById('mazemap-container');
            if (mapContainer) {
                mapContainer.style.opacity = '1';
                mapContainer.style.pointerEvents = 'auto';
            }
            
            if (!mazemapInstance) {
                initializeMazeMap();
                return;
            }

            isMapActive = true;
            document.getElementById('marker-info').style.display = 'block';
            
            // Reset guess
            currentGuess = null;
            updateMarkerInfo('Click on the map to place your guess');
        }

        // Deactivate map interaction (map stays visible but becomes non-interactive)
        function closeMap() {
            console.log('Closing map...');
            
            isMapActive = false;
            document.getElementById('marker-info').style.display = 'none';
            
            // Hide map container
            const mapContainer = document.getElementById('mazemap-container');
            if (mapContainer) {
                mapContainer.style.opacity = '0';
                mapContainer.style.pointerEvents = 'none';
            }
            
            // Clear markers
            clearAllMarkers();
        }

        // Submit guess with enhanced data (called by Unity, not web UI)
        function submitGuess() {
            if (!currentGuess || !unityInstance) return;

            try {
                const jsonData = JSON.stringify({
                    latitude: currentGuess.latitude,
                    longitude: currentGuess.longitude,
                    zLevel: currentGuess.zLevel || 0,
                    zLevelName: currentGuess.zLevelName || getZLevelName(0),
                    timestamp: Date.now()
                });
                
                unityInstance.SendMessage('MapInteractionManager', 'SubmitGuess', jsonData);
                updateMarkerInfo('Guess submitted!');
            } catch (error) {
                console.error('Error submitting guess:', error);
            }
        }

        // Update marker info display
        function updateMarkerInfo(text) {
            document.getElementById('marker-details').textContent = text;
        }

        // Marker cleanup functions
        function clearAllMarkers() {
            if (mazemapInstance) {
                if (mazemapInstance._playerMarker) {
                    mazemapInstance._playerMarker.remove();
                    mazemapInstance._playerMarker = null;
                }
                if (mazemapInstance._actualMarker) {
                    mazemapInstance._actualMarker.remove();
                    mazemapInstance._actualMarker = null;
                }
                console.log('All markers cleared');
            }
        }

        function removeMarkerById(id) {
            // Implementation for removing specific markers by ID
            console.log(`Removing marker with ID: ${id}`);
        }

        // Enhanced Unity communication functions
        function showMapFromUnity() {
            showMap(); // Activates map interaction
        }

        function hideMapFromUnity() {
            closeMap(); // Deactivates map interaction (map stays visible)
        }

        function addMarkerFromUnity(lat, lng, label, type) {
            const zLevel = mazemapInstance ? mazemapInstance.getZLevel() : 0;
            addEnhancedMarkerToMap(parseFloat(lat), parseFloat(lng), label, type, zLevel);
        }

        function addCustomMarkerFromUnity(markerData) {
            try {
                const data = JSON.parse(markerData);
                addEnhancedMarkerToMap(data.lat, data.lng, data.label || 'Marker', data.type || 'player', data.zLevel || 0);
            } catch (error) {
                console.error('Error parsing marker data:', error);
            }
        }

        function updateScoreFromUnity(score, round) {
            document.getElementById('current-score').textContent = score;
            document.getElementById('current-round').textContent = round;
            document.getElementById('score-display').style.display = 'block';
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function clearMarkersFromUnity() {
            clearAllMarkers();
        }

        // Expose functions globally for Unity
        window.showMapFromUnity = showMapFromUnity;
        window.hideMapFromUnity = hideMapFromUnity;
        window.addMarkerFromUnity = addMarkerFromUnity;
        window.addCustomMarkerFromUnity = addCustomMarkerFromUnity;
        window.updateScoreFromUnity = updateScoreFromUnity;
        window.showLoading = showLoading;
        window.clearMarkersFromUnity = clearMarkersFromUnity;
        window.clearAllMarkers = clearAllMarkers;

        console.log('MNET Geoguessr WebGL Template ready');
    </script>
</body>
</html>